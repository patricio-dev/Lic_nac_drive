name: Bot Licitaciones Celular

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  procesar-licitaciones:
    name: Bot Ejecucion Celular
    runs-on: self-hosted
    timeout-minutes: 1440 

    steps:
      - name: üì• Descargar c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Instalar dependencias (T√âCNICA DE EXTRACCI√ìN MANUAL)
        run: |
          # 1. Limpiamos el desastre del intento anterior
          # Esto repara el error "dpkg returned error code 1"
          dpkg --configure -a || true
          apt --fix-broken install -y || true

          # 2. Preparamos el repositorio (si no estaba ya)
          apt update && apt install software-properties-common -y
          add-apt-repository ppa:xtradeb/apps -y
          apt update

          # 3. Instalamos el NAVEGADOR y las LIBRER√çAS (Pero NO el driver a√∫n)
          # Nota: Usamos libasound2t64 porque tu Ubuntu es moderno (24.04+)
          apt install chromium libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2t64 -y

          # 4. TRUCO: Instalaci√≥n manual del Driver para saltar el error
          echo "üîß Instalando Driver manualmente..."
          
          # Descargamos el archivo .deb del driver sin instalarlo
          apt download chromium-driver
          
          # Lo descomprimimos en una carpeta temporal
          dpkg-deb -x chromium-driver*.deb temp_driver
          
          # Movemos el ejecutable a la carpeta de sistema a la fuerza
          mv temp_driver/usr/bin/chromedriver /usr/bin/chromedriver
          chmod +x /usr/bin/chromedriver
          
          # Borramos la basura
          rm -rf temp_driver chromium-driver*.deb
          
          echo "‚úÖ Driver instalado en /usr/bin/chromedriver"

          # 5. Instalar librer√≠as de Python
          pip3 install -r requirements.txt --break-system-packages --ignore-installed

      - name: üöÄ Ejecutar Bot
        env:
          GCP_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
        run: |
          python3 main.py --lote 1 --total_lotes 1
